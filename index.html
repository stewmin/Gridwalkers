<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gridwalkers Sandbox Prototype</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-sA+e2FjTm0EM0SK2hG3GLbFq3F7Vx1z+4v+g3Y2PzU8=" crossorigin=""/>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #222;
      color: #eee;
    }
    #map {
      width: 100%;
      height: 90%;
    }
    #notif {
      padding: 5px;
      text-align: center;
      background: #444;
    }
    #inventory {
      padding: 10px;
      background: #333;
    }
    .btn {
      padding: 6px 12px;
      margin: 4px;
      background: #555;
      color: #eee;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- Test Message -->
  <div id="test" style="padding:10px; background:#444; text-align:center;">Gridwalkers Prototype Loaded</div>
  <!-- Map Container -->
  <div id="map"></div>
  <!-- Notification Bar -->
  <div id="notif">Notifications will appear here</div>
  <!-- Inventory & Controls -->
  <div id="inventory">
    <strong>Inventory:</strong>
    <span id="inventoryList">Empty</span>
    <button id="clearInv" class="btn">Clear Inventory</button>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-o9N1j7kE1r0teY1AdNLq7kSE6mV0BtqgExbqtgtNzt8=" crossorigin=""></script>
  
  <!-- Our main script using Firebase modular SDK -->
  <script type="module">
    // Import Firebase modules from the CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
    
    /***********************
     * Firebase Setup
     ***********************/
    // Your web app's Firebase configuration (note the addition of databaseURL)
    const firebaseConfig = {
      apiKey: "AIzaSyDGaaEqlkNdlfBpDSDojctIOrhgwMchw6M",
      authDomain: "gridwalkers-f084e.firebaseapp.com",
      databaseURL: "https://gridwalkers-f084e-default-rtdb.firebaseio.com",  // Ensure this URL matches your project
      projectId: "gridwalkers-f084e",
      storageBucket: "gridwalkers-f084e.firebasestorage.app",
      messagingSenderId: "924068197891",
      appId: "1:924068197891:web:3dbb3dfbd07ce01f618036"
    };
    
    // Initialize Firebase and the Realtime Database
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // Generate a unique user id for this session
    const userId = "user_" + Math.random().toString(36).substr(2, 9);
    console.log("User ID:", userId);
    
    /***********************
     * Global Variables
     ***********************/
    let playerMarker;  // Player's marker on the map
    let currentPos = {lat: 40.7128, lng: -74.0060}; // Default: New York City
    let inventory = [];
    
    // Dummy arrays for safe zones and buildings
    const safeZones = [
      {lat: 40.7138, lng: -74.0050, type: "Fire Station"},
      {lat: 40.7120, lng: -74.0070, type: "Police Station"},
      {lat: 40.7130, lng: -74.0045, type: "Church"},
      {lat: 40.7115, lng: -74.0065, type: "Park"}
    ];
    
    const buildings = [
      {lat: 40.7132, lng: -74.0065, name: "Building A"},
      {lat: 40.7125, lng: -74.0055, name: "Building B"},
      {lat: 40.7129, lng: -74.0072, name: "Building C"}
    ];
    
    /***********************
     * Initialize Map with Leaflet
     ***********************/
    const map = L.map('map').setView([currentPos.lat, currentPos.lng], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    console.log("Map initialized", map);
    
    // Create player marker and add it to the map
    function createPlayerMarker(lat, lng) {
      if (playerMarker) map.removeLayer(playerMarker);
      playerMarker = L.marker([lat, lng]).addTo(map).bindPopup("You are here").openPopup();
    }
    createPlayerMarker(currentPos.lat, currentPos.lng);
    
    // Update player's current position and store it to Firebase
    function updatePlayerPosition(lat, lng) {
      currentPos = {lat, lng};
      createPlayerMarker(lat, lng);
      set(ref(db, 'players/' + userId), {
        location: currentPos,
        inventory: inventory,
        timestamp: Date.now()
      });
      console.log("Player position updated:", currentPos);
    }
    
    // Listen for map clicks to update player position and check nearby features
    map.on('click', function(e) {
      console.log("Map clicked at:", e.latlng);
      updatePlayerPosition(e.latlng.lat, e.latlng.lng);
      checkNearbySafeZones(e.latlng);
      checkNearbyPlayers(e.latlng);
    });
    
    /***********************
     * Render Safe Zones & Buildings
     ***********************/
    safeZones.forEach(zone => {
      const icon = L.divIcon({
        html: `<div style="background: #0a0; border-radius: 50%; width: 20px; height: 20px; text-align:center; line-height:20px; color:#fff;">${zone.type.charAt(0)}</div>`,
        className: ''
      });
      L.marker([zone.lat, zone.lng], {icon: icon}).addTo(map).bindPopup(zone.type);
    });
    
    buildings.forEach(bldg => {
      const marker = L.marker([bldg.lat, bldg.lng], {icon: L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      })}).addTo(map);
      marker.bindPopup(bldg.name + "<br/><button onclick='lootBuilding(\"" + bldg.name + "\")'>Loot</button>");
    });
    
    // Handle building looting
    window.lootBuilding = function(buildingName) {
      const lootItems = ["Old Gun", "Ammo Box", "Medkit", "Rare Key", "Empty Bottle"];
      const loot = lootItems[Math.floor(Math.random() * lootItems.length)];
      inventory.push({building: buildingName, item: loot});
      updateInventoryDisplay();
      showNotification("Looted " + loot + " from " + buildingName);
      set(ref(db, 'players/' + userId + '/inventory'), inventory);
    };
    
    // Update the inventory display area
    function updateInventoryDisplay() {
      document.getElementById("inventoryList").innerText = inventory.map(i => i.item).join(", ") || "Empty";
    }
    
    // Clear inventory on button click
    document.getElementById("clearInv").addEventListener("click", function(){
      inventory = [];
      updateInventoryDisplay();
      set(ref(db, 'players/' + userId + '/inventory'), inventory);
    });
    
    /***********************
     * Zombie Spawns
     ***********************/
    function spawnZombie() {
      const latOffset = (Math.random() - 0.5) * 0.001;
      const lngOffset = (Math.random() - 0.5) * 0.001;
      const zombieLat = currentPos.lat + latOffset;
      const zombieLng = currentPos.lng + lngOffset;
      
      const zombieMarker = L.marker([zombieLat, zombieLng], {icon: L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/1041/1041910.png',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      })}).addTo(map);
      zombieMarker.bindPopup("Zombie! <br/><button onclick='defeatZombie(this, " + zombieLat + ", " + zombieLng + ")'>Attack</button>");
      // Remove zombie marker after 30 seconds
      setTimeout(() => { map.removeLayer(zombieMarker); }, 30000);
    }
    
    window.defeatZombie = function(button, lat, lng) {
      map.closePopup();
      const zombieLoot = ["Zombie Tooth", "Torn Cloth", "Ammo Scrap"];
      const loot = zombieLoot[Math.floor(Math.random() * zombieLoot.length)];
      inventory.push({source: "Zombie", item: loot});
      updateInventoryDisplay();
      showNotification("Defeated zombie and looted: " + loot);
    };
    
    // Spawn a zombie every 30 seconds
    setInterval(spawnZombie, 30000);
    
    /***********************
     * Safe Zones & Nearby Players
     ***********************/
    function checkNearbySafeZones(latlng) {
      safeZones.forEach(zone => {
        const dist = map.distance(latlng, L.latLng(zone.lat, zone.lng));
        if (dist < 30) {
          showNotification("You are within a safe zone (" + zone.type + "). You can rest and trade here.");
        }
      });
    }
    
    function checkNearbyPlayers(latlng) {
      // Retrieve all players from the database once
      get(ref(db, 'players')).then(snapshot => {
        let playersFound = [];
        snapshot.forEach(childSnap => {
          const p = childSnap.val();
          if (childSnap.key !== userId && p.location) {
            const dist = map.distance(latlng, L.latLng(p.location.lat, p.location.lng));
            if (dist < 50) playersFound.push(childSnap.key);
          }
        });
        if (playersFound.length > 0) {
          showNotification("Players nearby: " + playersFound.join(", "));
        }
      });
    }
    
    // Display notifications to the user
    function showNotification(message) {
      const notifDiv = document.getElementById("notif");
      notifDiv.innerText = message;
      setTimeout(() => { notifDiv.innerText = ""; }, 5000);
    }
    
    /***********************
     * Firebase Player Sync (Live Updates)
     ***********************/
    onValue(ref(db, 'players'), (snapshot) => {
      snapshot.forEach(childSnap => {
        const p = childSnap.val();
        if (childSnap.key !== userId && p.location) {
          const dist = map.distance(currentPos, L.latLng(p.location.lat, p.location.lng));
          if (dist < 50) {
            showNotification("Player " + childSnap.key + " is close by on your road!");
          }
        }
      });
    });
    
  </script>
</body>
</html>
