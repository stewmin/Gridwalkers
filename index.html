<!DOCTYPE html>
<html>
<head>
  <title>Gridwalkers – Zombie Survival Prototype</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet and Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <style>
    /* ---------- Base ---------- */
    body { margin:0; padding:0; font-family:Arial,sans-serif; }
    #map { position:absolute; top:60px; bottom:0; left:0; right:0; }

    /* ---------- UI Panels ---------- */
    #loginOverlay { position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8); z-index:4000;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      color:#fff;
    }
    #loginOverlay h1 { color:limegreen; margin-bottom:20px; }
    #loginOverlay form { background:#333; padding:20px; border-radius:4px; text-align:center; }
    #loginOverlay input, #loginOverlay button { margin:5px; padding:5px; }

    #searchBar { position:absolute; top:5px; left:10px; z-index:1500;
      background:rgba(255,255,255,0.9); padding:6px; border-radius:4px;
    }
    #searchBar input, #searchBar button { font-size:12px; margin:2px; }

    #statusDisplay { position:absolute; top:5px; right:10px; z-index:2000;
      background:rgba(255,255,255,0.9); padding:6px; border-radius:4px; font-size:12px;
    }

    #roadList { position:absolute; top:60px; right:0; width:300px;
      max-height:calc(100% - 60px); overflow-y:auto;
      background:rgba(255,255,255,0.95); padding:10px; z-index:1400; font-size:14px;
    }
    #roadList h3 { margin:0; display:flex; justify-content:space-between; align-items:center; }
    #roadFilter { width:100%; padding:4px; margin:5px 0; box-sizing:border-box; }
    .road-item { padding:5px; border-bottom:1px solid #ccc; cursor:pointer; }
    .road-code { font-weight:bold; background:#f0f0f0; padding:2px 4px; border-radius:3px; }
    #roadListToggle { position:absolute; top:60px; right:0; z-index:1500;
      display:none; background:rgba(255,255,255,0.9);
      padding:5px 10px; cursor:pointer; font-size:14px; border-radius:0 0 0 5px;
    }

    /* ---------- Sprites & Markers ---------- */
    .player-sprite, .zombie-sprite { display:inline-block; }
    .player-sprite > div, .zombie-sprite > div { width:6px; height:6px; display:block; }
    .player-head { background:#f1c27d; } .player-torso { background:blue; } .player-boots { background:black; }
    .zombie-head { background:green; } .zombie-torso { background:darkgreen; } .zombie-boots { background:black; }
    .move-radius { fill:rgba(0,0,255,0.1); stroke:blue; stroke-width:1; }
    .loot-box { width:10px; height:10px; background:sienna; border:1px solid #000;
      text-align:center; line-height:10px; color:#fff; font-size:8px;
    }
  </style>
</head>
<body>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay">
    <h1>GRIDWALKERS</h1>
    <form id="loginForm">
      <input type="text" id="usernameInput" placeholder="Username" required /><br>
      <input type="password" id="passwordInput" placeholder="Password" required /><br>
      <button type="button" id="registerBtn">Register</button>
      <button type="button" id="loginBtn">Login</button>
    </form>
  </div>

  <!-- SEARCH BAR -->
  <div id="searchBar">
    <input type="text" id="addressInput" placeholder="Enter your address" size="20" />
    <button id="searchBtn">Search</button>
  </div>

  <!-- STATUS DISPLAY -->
  <div id="statusDisplay">
    Health: <span id="healthDisplay">100</span> |
    Score: <span id="scoreDisplay">0</span>
  </div>

  <!-- MAP -->
  <div id="map"></div>

  <!-- ROAD LIST PANEL -->
  <div id="roadList">
    <h3>Road List <button id="toggleRoadListBtn">Close</button></h3>
    <input type="text" id="roadFilter" placeholder="Filter roads…" />
    <div id="roadsContainer">No roads loaded.</div>
  </div>
  <div id="roadListToggle">Show Road List</div>

  <!-- LEAFLET & DRAW -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <script>
  // Wait until ALL DOM is ready
  window.onload = function() {
    console.log("🏁 App initializing…");

    // ─── Globals ───────────────────────────────────────────
    let map, drawnItems, gridBox;
    let playerMarker=null, moveIndicator;
    let playerHealth=100, playerScore=0, equippedItem=null;
    let backpack=[], currentUser=null;
    let zombieLayer, lootLayer, zombieMarkers=[];
    let lootCooldowns={};  // only set after pickup

    // ─── Utils ──────────────────────────────────────────────
    function toRad(v){ return v*Math.PI/180; }
    function getDistanceMeters(lat1,lng1,lat2,lng2){
      const R=6371000,
            dLat=toRad(lat2-lat1),
            dLng=toRad(lng2-lng1);
      const a = Math.sin(dLat/2)**2
              + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))
              * Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function loadProfiles(){
      const p = localStorage.getItem("gridwalkers_profiles");
      return p ? JSON.parse(p) : {};
    }
    function saveState(){
      if(!currentUser) return;
      const p = loadProfiles();
      p[currentUser].state = {
        health: playerHealth,
        score: playerScore,
        equipped: equippedItem,
        backpack: backpack,
        spawnPoint: playerMarker.getLatLng()
      };
      localStorage.setItem("gridwalkers_profiles", JSON.stringify(p));
    }

    // ─── Login / Register ────────────────────────────────────
    document.getElementById("registerBtn").onclick = function(){
      console.log("🔐 Register clicked");
      const u = document.getElementById("usernameInput").value.trim();
      const pw= document.getElementById("passwordInput").value;
      if(!u||!pw) return alert("Please fill both fields.");
      const p = loadProfiles();
      if(p[u]) return alert("Username taken.");
      p[u] = { password: pw, state:{ health:100,score:0,equipped:null,backpack:[],spawnPoint:null }};
      localStorage.setItem("gridwalkers_profiles", JSON.stringify(p));
      alert("Registered! Now log in.");
    };

    document.getElementById("loginBtn").onclick = function(){
      console.log("🔑 Login clicked");
      const u = document.getElementById("usernameInput").value.trim();
      const pw= document.getElementById("passwordInput").value;
      const p = loadProfiles();
      if(!p[u]) return alert("User not found.");
      if(p[u].password !== pw) return alert("Incorrect password.");
      currentUser = u;
      // Restore state
      const s = p[u].state;
      playerHealth = s.health; playerScore = s.score;
      equippedItem = s.equipped; backpack = s.backpack||[];
      document.getElementById("loginOverlay").style.display = "none";

      initMap();
      // If saved spawnPoint, go there; else default
      const sp = s.spawnPoint || { lat:36.85, lon:-87.55 };
      spawnPlayerAt(sp.lat, sp.lon);
      map.setView([sp.lat, sp.lon], 18);
      updateStatusDisplay();

      // Start loops *after* login
      setInterval(spawnZombie, 30000);
      setInterval(updateZombies, 1000);
      setInterval(fetchBuildingsAndSpawnLoot, 30000);
    };

    // ─── MAP & DRAW INIT ────────────────────────────────────
    function initMap(){
      map = L.map('map').setView([36.85, -87.55], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom:19, attribution:'© OpenStreetMap contributors'
      }).addTo(map);

      // Road‐list draw box
      drawnItems = new L.FeatureGroup().addTo(map);
      const drawCtrl = new L.Control.Draw({
        draw:{
          polyline:false, polygon:false, circle:false, marker:false, circlemarker:false,
          rectangle:{ shapeOptions:{ color:"#3388ff", weight:2 } }
        },
        edit:{ featureGroup:drawnItems, edit:true, remove:false }
      });
      map.addControl(drawCtrl);
      map.on(L.Draw.Event.CREATED, e => {
        drawnItems.clearLayers();
        gridBox = e.layer;
        gridBox.setStyle({ opacity:0, fillOpacity:0 });
        drawnItems.addLayer(gridBox);
        fetchAndDisplayRoads();
      });
      map.on('draw:edited', fetchAndDisplayRoads);

      // Zombie & loot layers
      zombieLayer = L.layerGroup().addTo(map);
      lootLayer   = L.layerGroup().addTo(map);

      // Click → move
      map.on('click', e => {
        if(playerMarker) animatePlayerMove(e.latlng.lat, e.latlng.lng);
      });

      // Address search
      document.getElementById("searchBtn").onclick = () => {
        const addr = document.getElementById("addressInput").value;
        if(!addr) return;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`)
          .then(r=>r.json())
          .then(data => {
            if(!data.length) return alert("Address not found");
            const lat=parseFloat(data[0].lat),
                  lon=parseFloat(data[0].lon);
            map.setView([lat,lon],18);
            spawnPlayerAt(lat, lon);
            saveState();
          });
      };
    }

    // ─── PLAYER MOVEMENT ────────────────────────────────────
    function createPlayerHTML(){
      return '<div class="player-sprite">'
        +'<div class="player-head"></div>'
        +'<div class="player-torso"></div>'
        +'<div class="player-boots"></div>'
        +'</div>';
    }
    function spawnPlayerAt(lat, lon){
      if(playerMarker) map.removeLayer(playerMarker);
      playerMarker = L.marker([lat, lon], {
        icon: L.divIcon({ html:createPlayerHTML(), iconSize:[6,18] })
      }).addTo(map).bindPopup("You");
      updateMoveIndicator();
    }
    function updateMoveIndicator(){
      if(moveIndicator) map.removeLayer(moveIndicator);
      if(!playerMarker) return;
      moveIndicator = L.circle(playerMarker.getLatLng(), {
        radius:50, className:'move-radius'
      }).addTo(map);
    }
    function animatePlayerMove(tLat, tLng){
      const start = playerMarker.getLatLng();
      const dist  = getDistanceMeters(start.lat, start.lng, tLat, tLng);
      const speed = 20; // m/s
      const dur   = Math.max(dist/speed*1000, 500);
      let   t0;
      function step(ts){
        if(!t0) t0=ts;
        let prog = (ts-t0)/dur; if(prog>1) prog=1;
        let lat = start.lat + (tLat-start.lat)*prog;
        let lng = start.lng + (tLng-start.lng)*prog;
        playerMarker.setLatLng([lat,lng]);
        updateMoveIndicator();
        if(prog<1) requestAnimationFrame(step);
        else saveState();
      }
      requestAnimationFrame(step);
      map.panTo([tLat,tLng], { animate:true, duration:dur/1000 });
    }

    // ─── ROADS via Overpass & RHQC ─────────────────────────
    let roadPolylines=[];
    function fetchAndDisplayRoads(){
      if(!gridBox) return document.getElementById("roadsContainer").innerText = "No grid box defined.";
      const b = gridBox.getBounds();
      const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;
      const query = `[out:json][timeout:25];
        ( way["highway"](${bbox}); );
        out geom;`;
      fetch("https://overpass-api.de/api/interpreter", {
        method:"POST", body:"data="+encodeURIComponent(query)
      })
      .then(r=>r.json())
      .then(d=> processRoadData(d.elements, b))
      .catch(_=> document.getElementById("roadsContainer").innerText="Error loading roads.");
    }
    function processRoadData(elements, gridBounds){
      const roads=[]; roadPolylines=[];
      elements.forEach(el=>{
        if(el.type==="way" && el.tags && el.tags.name && el.geometry){
          const coords = el.geometry.map(p=>[p.lat,p.lon]);
          roads.push({ name:el.tags.name, polyline:coords });
          roadPolylines.push({ name:el.tags.name, polyline:coords });
        }
      });
      roads.sort((a,b)=>a.name.localeCompare(b.name));
      let html="";
      roads.forEach(r=>{
        const mid = r.polyline[Math.floor(r.polyline.length/2)];
        const code = getRHQCCode(mid[0], mid[1],
          [[gridBounds.getSouth(),gridBounds.getWest()],
           [gridBounds.getNorth(),gridBounds.getEast()]], 5);
        html += `<div class="road-item">
                   <span class="road-code">${code}</span> ${r.name}
                 </div>`;
      });
      document.getElementById("roadsContainer").innerHTML = html||"No roads found.";
    }
    document.getElementById("roadFilter").oninput = () => {
      const ft = document.getElementById("roadFilter").value.toLowerCase();
      document.querySelectorAll("#roadsContainer .road-item").forEach(it=>{
        it.style.display = it.textContent.toLowerCase().includes(ft) ? "" : "none";
      });
    };
    document.getElementById("toggleRoadListBtn").onclick = ()=>{
      document.getElementById("roadList").style.display="none";
      document.getElementById("roadListToggle").style.display="block";
    };
    document.getElementById("roadListToggle").onclick = ()=>{
      document.getElementById("roadList").style.display="block";
      document.getElementById("roadListToggle").style.display="none";
    };
    function getRHQCCode(lat,lng,bounds,maxLevel){
      let code="", cb=JSON.parse(JSON.stringify(bounds));
      for(let lvl=1;lvl<=maxLevel;lvl++){
        const [s,w]=cb[0], [n,e]=cb[1];
        const midLat=(s+n)/2, midLng=(w+e)/2;
        if(lat>=midLat && lng<=midLng){
          code+="1"; cb=[[midLat,w],[n,midLng]];
        } else if(lat>=midLat && lng>midLng){
          code+="2"; cb=[[midLat,midLng],[n,e]];
        } else if(lat<midLat && lng<=midLng){
          code+="3"; cb=[[s,w],[midLat,midLng]];
        } else {
          code+="4"; cb=[[s,midLng],[midLat,e]];
        }
      }
      return code;
    }

    // ─── ZOMBIES ────────────────────────────────────────────
    function spawnZombie(){
      if(!playerMarker) return;
      const p = playerMarker.getLatLng();
      const d = 100 + Math.random()*100, a = Math.random()*360;
      const s = destinationPoint(p.lat,p.lng,a,d);
      const icon = L.divIcon({ html:createZombieHTML(), iconSize:[6,18] });
      const m = L.marker([s.lat,s.lng],{icon}).addTo(zombieLayer).bindPopup("Zombie!");
      m.zombieHealth = 3;
      zombieMarkers.push({ marker:m });
    }
    function createZombieHTML(){
      return '<div class="zombie-sprite">'
        +'<div class="zombie-head"></div>'
        +'<div class="zombie-torso"></div>'
        +'<div class="zombie-boots"></div>'
        +'</div>';
    }
    function updateZombies(){
      if(!playerMarker) return;
      const p = playerMarker.getLatLng();
      for(let i=zombieMarkers.length-1;i>=0;i--){
        const zObj = zombieMarkers[i], zp=zObj.marker.getLatLng();
        const dist=getDistanceMeters(p.lat,p.lng,zp.lat,zp.lng);
        if(dist>1000){
          zombieLayer.removeLayer(zObj.marker);
          zombieMarkers.splice(i,1);
          continue;
        }
        let target, speed;
        if(dist<50){
          target={lat:p.lat,lng:p.lng}; speed=18;
        } else {
          const wd=Math.random()*5, wa=Math.random()*360;
          target = destinationPoint(zp.lat,zp.lng,wa,wd);
          speed=10;
        }
        animateZombieMove(zObj.marker,target.lat,target.lng,speed);
        if(dist<5){
          playerHealth--; updateStatusDisplay();
          if(playerHealth<=0){ alert("You died"); resetGame(); return; }
        }
      }
    }
    function animateZombieMove(marker, tLat, tLng, speed){
      const start=marker.getLatLng();
      const dist = getDistanceMeters(start.lat,start.lng, tLat,tLng);
      const dur  = Math.max(dist/speed*1000,500);
      let t0;
      function step(ts){
        if(!t0)t0=ts;
        let p=(ts-t0)/dur; if(p>1)p=1;
        let nl=start.lat+(tLat-start.lat)*p,
            nlng=start.lng+(tLng-start.lng)*p;
        marker.setLatLng([nl,nlng]);
        if(p<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    zombieLayer && zombieLayer.on('click', e=>{
      if(!equippedItem||equippedItem.type!=="gun") return alert("Equip a gun!");
      const clicked = e.layer, p=playerMarker.getLatLng(), zp=clicked.getLatLng();
      const dist=getDistanceMeters(p.lat,p.lng,zp.lat,zp.lng);
      if(dist>equippedItem.range) return alert("Out of range");
      const ai=backpack.findIndex(i=>i.type==="ammo");
      if(ai<0) return alert("No ammo");
      backpack[ai].quantity--;
      if(backpack[ai].quantity<=0) backpack.splice(ai,1);
      clicked.zombieHealth -= equippedItem.damage;
      if(clicked.zombieHealth<=0){
        zombieLayer.removeLayer(clicked);
        zombieMarkers = zombieMarkers.filter(z=>z.marker!==clicked);
        playerScore++; updateStatusDisplay();
      }
    });

    // ─── LOOT : Overpass Buildings + pickup cooldown ─────────
    function fetchBuildingsAndSpawnLoot(){
      if(!playerMarker) return;
      const p=playerMarker.getLatLng(), d=0.01;
      const s=p.lat-d, n=p.lat+d, w=p.lng-d, e=p.lng+d;
      const bbox=`${s},${w},${n},${e}`;
      const q=`[out:json][timeout:25];(way["building"](${bbox}););out center;`;
      fetch("https://overpass-api.de/api/interpreter", {
        method:"POST", body:"data="+encodeURIComponent(q)
      })
      .then(r=>r.json())
      .then(data=>{
        data.elements.forEach(el=>{
          if(!el.center) return;
          const key=`${el.center.lat.toFixed(5)}_${el.center.lon.toFixed(5)}`;
          if(lootCooldowns[key] && Date.now()<lootCooldowns[key]) return;
          // spawn loot
          const loot=generateRandomLoot();
          const ico=L.divIcon({ html:'<div class="loot-box">L</div>', iconSize:[10,10] });
          const m=L.marker([el.center.lat,el.center.lon],{icon:ico}).addTo(lootLayer);
          m.loot=loot; m._lootKey=key;
          m.on('click',()=> pickupLoot(m) );
        });
      })
      .catch(_=>console.warn("Overpass error"));
    }
    function pickupLoot(marker){
      backpack.push(marker.loot);
      updateInventoryUI();
      alert("Looted: "+marker.loot.name + (marker.loot.type==="ammo"?" x"+marker.loot.quantity:""));
      lootLayer.removeLayer(marker);
      // start cooldown *after* pickup
      lootCooldowns[marker._lootKey] = Date.now() + 5*60*1000;
    }
    function generateRandomLoot(){
      const table=[
        {chance:0.3, item:{type:"ammo",name:"ammo",quantity:10}},
        {chance:0.2, item:{type:"gun", name:"pistol",damage:1,range:100}},
        {chance:0.15,item:{type:"gun", name:"shotgun",damage:3,range:20}},
        {chance:0.15,item:{type:"gun", name:"AR15",damage:2,range:200}},
        {chance:0.1, item:{type:"gun", name:"hunting rifle",damage:3,range:400}},
        {chance:0.1, item:{type:"consumable",name:"bandage",effect:"heal",amount:10}}
      ];
      let r=Math.random(), cum=0;
      for(const row of table){
        cum += row.chance;
        if(r<cum) return JSON.parse(JSON.stringify(row.item));
      }
      return {type:"ammo",name:"ammo",quantity:5};
    }

    // ─── Status & Reset ─────────────────────────────────────
    function updateStatusDisplay(){
      document.getElementById("healthDisplay").textContent=playerHealth;
      document.getElementById("scoreDisplay").textContent=playerScore;
    }
    function updateInventoryUI(){
      console.log("Backpack:",backpack);
    }
    function resetGame(){
      alert("Game Over! Score: "+playerScore);
      localStorage.removeItem("gridwalkers_profiles");
      location.reload();
    }
    window.addEventListener("beforeunload", saveState);

    // Point/coordinate helper for zombie destination
    function destinationPoint(lat, lon, bearing, distance){
      const R=6371000, δ=distance/R, θ=toRad(bearing),
            φ1=toRad(lat), λ1=toRad(lon);
      const φ2=Math.asin(Math.sin(φ1)*Math.cos(δ)
                +Math.cos(φ1)*Math.sin(δ)*Math.cos(θ)),
            λ2=λ1+Math.atan2(Math.sin(θ)*Math.sin(δ)*Math.cos(φ1),
                             Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2));
      return { lat:φ2*180/Math.PI, lng:λ2*180/Math.PI };
    }

  }; // end window.onload
  </script>
</body>
</html>
